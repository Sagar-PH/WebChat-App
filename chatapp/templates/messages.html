<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Telegram Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Inter", sans-serif;
            height: 100%;
            overflow: hidden;
            background: #ffffff;
        }

        .app {
            display: grid;
            grid-template-columns: 25% 75%;
            height: 100vh;
            width: 100%;
        }

        /* ================= LEFT SIDEBAR ================= */

        .add-friend-btn {
            text-decoration: none;
            color: black;
            float: right;
        }

        .sidebar {
            background: #f7f7f7;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 16px;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid #ddd;
        }

        .search-box {
            padding: 12px;
        }

        .search-box input {
            outline: none;
            width: 95%;
            padding: 10px;
            border: none;
            border-radius: 10px;
            background: #ececec;
            font-size: 14px;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            padding: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-item:hover,
        .chat-item.active {
            background: #e9f3ff;
        }

        .chat-item img {
            height: 48px;
            width: 48px;
            border-radius: 50%;
        }

        .chat-details span {
            display: block;
            font-weight: 600;
            font-size: 15px;
        }

        .chat-details small {
            color: #666;
        }

        /* ================= RIGHT CHAT AREA ================= */

        #send-message-form {
            flex-shrink: 0;
            background: white;
            border-top: 1px solid #ddd;
        }

        .chat-window {
            background: #e5f3ff;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            position: fixed;
            width: 100%;
            z-index: 1;
            flex-shrink: 0;
            height: 60px;
            padding: 12px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border-bottom: 1px solid #ddd;
        }


        .chat-header img {
            height: 42px;
            width: 42px;
            border-radius: 50%;
        }

        .chat-header .name {
            font-weight: 600;
        }

        .chat-header .sub {
            font-size: 12px;
            color: #777;
        }

        /* ================= MESSAGES ================= */

        .messages {
            padding: 20px;
            position: relative;
        }

        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            display: none;
        }

        .messages-wrapper.is_active {
            display: block;
        }

        .message {
            max-width: 25%;
            padding: 10px 14px;
            border-radius: 25px;
            margin-bottom: 14px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
        }

        .sent {
            background: #0088cc;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }

        .received {
            background: white;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 3px;
            margin-top: 10px;
        }

        .timestamp {
            position: absolute;
            bottom: -18px;
            right: 6px;
            font-size: 11px;
            opacity: 0.6;
        }

        /* ================= INPUT ================= */

        .chat-input {
            padding: 12px;
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            outline: none;
            flex: 1;
            padding: 12px 14px;
            border-radius: 1.5vw;
            border: 1px solid #ccc;
            background: #f2f2f2;
            font-size: 15px;
        }

        .chat-input button {
            width: 50px;
            border: none;
            border-radius: 50%;
            background: #0088cc;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    {% if user.is_authenticated %}
    <input type="hidden" id="logged-in-user" value="{{ user.id }}">
    {% endif %}

    <div class="app">

        <!-- LEFT SIDEBAR -->
        <div class="sidebar">

            <div class="sidebar-header">
                Chats
                <a href="{% url 'add_friend' %}" class="add-friend-btn" title="Add Friend">+</a>
            </div>


            <div class="search-box">
                <input type="text" placeholder="Search">
            </div>

            <div class="chat-list">
                {% for thread in Threads %}
                <div class="chat-item contact-li {% if forloop.first %}active{% endif %}"
                    chat-id="chat_{{ thread.id }}">
                    <img src="https://i.postimg.cc/TYznZ8GK/download-1.jpg">
                    <div class="chat-details">
                        {% if thread.first_person == user %}
                        <span>{{ thread.second_person.username }}</span>
                        {% else %}
                        <span>{{ thread.first_person.username }}</span>
                        {% endif %}
                        <small>{{ thread.chatmessage_thread.last.message|truncatechars:25 }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>

        <!-- RIGHT CHAT WINDOW -->
        <div class="chat-window">

            {% for thread in Threads %}
            <div class="messages-wrapper {% if forloop.first %}is_active{% endif %}" chat-id="chat_{{ thread.id }}"
                other-user-id="
                {% if thread.first_person == user %}
                    {{ thread.second_person.id }}
                {% else %}
                    {{ thread.first_person.id }}
                {% endif %}
             ">

                <div class="chat-header">
                    <img src="https://i.postimg.cc/TYznZ8GK/download-1.jpg">
                    <div>
                        {% if thread.first_person == user %}
                        <div class="name">{{ thread.second_person.username }}</div>
                        {% else %}
                        <div class="name">{{ thread.first_person.username }}</div>
                        {% endif %}
                        <div class="sub">{{ thread.chatmessage_thread.all.count }} messages</div>
                    </div>
                </div>

                <!-- MESSAGES -->
                <div class="messages">
                    {% for chat in thread.chatmessage_thread.all %}
                    {% if chat.user == user %}
                    <div class="message sent">
                        {{ chat.message }}
                        <div class="timestamp">{{ chat.timestamp|time:"H:i" }}</div>
                    </div>
                    {% else %}
                    <div class="message received">
                        {{ chat.message }}
                        <div class="timestamp">{{ chat.timestamp|time:"H:i" }}</div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>

            </div>
            {% endfor %}

            <!-- INPUT -->
            {% if Threads %}
            <form id="send-message-form">
                <div class="chat-input">
                    <input id="input-message" placeholder="Message">
                    <button type="submit"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </form>
            {% else %}
            <div style="text-align:center; padding:20px; color:#777;">
                No conversations yet. Add a friend to start chatting!
            </div>
            {% endif %}


        </div>

    </div>

    <!-- ================= JAVASCRIPT ================= -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <script>

        let input_message = $('#input-message')
        let send_message_form = $('#send-message-form')
        const USER_ID = $('#logged-in-user').val()

        let loc = window.location
        let wsStart = loc.protocol === 'https:' ? 'wss://' : 'ws://'
        let endpoint = wsStart + loc.host + loc.pathname

        let socket = new WebSocket(endpoint)

        /* ========== WebSocket CONNECTED ========== */
        socket.onopen = function () {

            send_message_form.on("submit", function (e) {
                e.preventDefault()

                let message = input_message.val().trim()
                if (!message) return false

                let send_to = get_active_other_user_id()
                let thread_id = get_active_thread_id()

                let data = JSON.stringify({
                    message: message,
                    sent_by: USER_ID,
                    send_to: send_to,
                    thread_id: thread_id
                })

                socket.send(data)
                input_message.val("")
            })
        }

        /* ========== WebSocket MESSAGE RECEIVED ========== */
        socket.onmessage = function (e) {
            let data = JSON.parse(e.data)
            newMessage(data)
        }

        /* ========== APPEND NEW TELEGRAM BUBBLE ========== */
        function newMessage({ message, sent_by, thread_id, timestamp }) {

            if (!timestamp) {
                let now = new Date()
                timestamp =
                    now.getHours().toString().padStart(2, '0') + ":" +
                    now.getMinutes().toString().padStart(2, '0')
            }

            let safe_message = $('<div>').text(message).html()
            let chat_id = "chat_" + thread_id
            let wrapper = $('.messages-wrapper[chat-id="' + chat_id + '"] .messages')

            let html = `
        <div class="message ${sent_by == USER_ID ? 'sent' : 'received'}">
            ${safe_message}
            <div class="timestamp">${timestamp}</div>
        </div>
    `

            wrapper.append(html)

            // auto scroll only active chat
            if ($('.messages-wrapper[chat-id="' + chat_id + '"]').hasClass('is_active')) {
                wrapper.scrollTop(wrapper[0].scrollHeight)
            }
        }

        /* ========== SWITCH THREAD ========== */
        $('.contact-li').on('click', function () {
            $('.contact-li.active').removeClass('active')
            $(this).addClass('active')

            let chat_id = $(this).attr('chat-id')

            $('.messages-wrapper.is_active').removeClass('is_active')
            $('.messages-wrapper[chat-id="' + chat_id + '"]').addClass('is_active')

            let wrapper = $('.messages-wrapper[chat-id="' + chat_id + '"] .messages')
            wrapper.scrollTop(wrapper[0].scrollHeight)
        })

        /* ========== Helpers ========== */
        function get_active_other_user_id() {
            return $('.messages-wrapper.is_active').attr('other-user-id').trim()
        }

        function get_active_thread_id() {
            let id = $('.messages-wrapper.is_active').attr('chat-id')
            return id.replace("chat_", "")
        }

        const message_box = document.getElementsByClassName('messages')
        const chat_header = document.getElementsByClassName('chat-header')[0]

        Array.from(message_box).forEach((message) => {
            message.style.top = String(chat_header.getBoundingClientRect().height) + 'px'
        })

        window.addEventListener('resize', () => {
            const header_heigth = chat_header.getBoundingClientRect().height
            Array.from(message_box).forEach((message) => {
                message.style.top = String(header_heigth) + 'px'
            })
        })

    </script>

</body>

</html>
